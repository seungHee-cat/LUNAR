<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="project.kr.movie.mapper.MovieMapper">

    <!-- 영화 목록 조회 -->
    <select id="getMovieList" parameterType="MovieVO" resultType="MovieVO">
        <![CDATA[
        /*	getMovieList  */
            SELECT
                MOVIE_ID
                , TITLE
                , BACKDROP_PATH
                , GENRE_IDS
                , ORIGINAL_TITLE
                , RELEASE_YEAR
                , ORIGINAL_LANGUAGE
                , RUNTIME
                , POSTER_PATH
                , VOTE_AVERAGE
                , VOTE_COUNT
                , TAGLINE
                , OVERVIEW
                , POPULARITY
                , GROUP_NUM
                , PRODUCTION_COUNTRIES
            FROM MOVIE
        ]]>
        <where>
            <if test="groupNum != null and groupNum != ''">
                AND GROUP_NUM = #{groupNum}
            </if>
            <if test="schTitle != null and schTitle != ''">
                AND UPPER(REPLACE(TITLE, ' ', '')) LIKE CONCAT('%', UPPER(REPLACE(#{schTitle}, ' ', '')), '%')
            </if>
        </where>
        <![CDATA[
            ORDER BY POPULARITY DESC
        ]]>
        <if test="groupNum == 1">
            LIMIT 20
        </if>
        <if test="groupNum != 1">
            LIMIT 30
        </if>
    </select>

    <!-- 영화 목록 추가 -->
    <insert id="insertMovie" parameterType="MovieVO" >
        <![CDATA[
        /*	insertMovie	*/
        INSERT IGNORE INTO MOVIE
        (
              MOVIE_ID
            , TITLE
            , BACKDROP_PATH
            , GENRE_IDS
            , ORIGINAL_TITLE
            , RELEASE_YEAR
            , ORIGINAL_LANGUAGE
            , RUNTIME
            , POSTER_PATH
            , VOTE_AVERAGE
            , VOTE_COUNT
            , TAGLINE
            , OVERVIEW
            , POPULARITY
            , GROUP_NUM
            , PRODUCTION_COUNTRIES
        ) VALUES(
            #{movieId}
            , #{title}
            , #{backdropPath}
            , #{genreIds}
            , #{originalTitle}
            , #{releaseYear}
            , #{originalLanguage}
            , #{runtime}
            , #{posterPath}
            , #{voteAverage}
            , #{voteCount}
            , #{tagline}
            , #{overview}
            , #{popularity}
            , #{groupNum}
            , #{productionCountries}
        )
    ]]>
    </insert>

    <!-- 영화 목록 개수 조회 -->
    <select id="getMovieListCnt" parameterType="MovieVO" resultType="Integer">
        <![CDATA[
        /*	getMovieListCnt	*/
            SELECT
                COUNT(*)
            FROM
                MOVIE
            WHERE
                GROUP_NUM = #{groupNum}
            ORDER BY
                POPULARITY
        ]]>
    </select>

    <!-- 영화 상세 페이지 조회 -->
    <select id="getMovieDetail" parameterType="MovieVO" resultType="MovieVO">
        <![CDATA[
        /*	getMovieDetail	*/
            SELECT
              MOVIE_ID
                , TITLE
                , BACKDROP_PATH
                , GENRE_IDS
                , ORIGINAL_TITLE
                , RELEASE_YEAR
                , ORIGINAL_LANGUAGE
                , RUNTIME
                , POSTER_PATH
                , VOTE_AVERAGE
                , VOTE_COUNT
                , TAGLINE
                , OVERVIEW
                , POPULARITY
                , GROUP_NUM
                , PRODUCTION_COUNTRIES
            FROM
                MOVIE
        ]]>
        <where>
            <if test="movieId != null and movieId != ''">
                AND MOVIE_ID = #{movieId}
            </if>
        </where>
    </select>

    <!-- 영화 검색 조회 -->
    <select id="getMovieSchListAjax" parameterType="MovieVO" resultType="MovieVO">
        <![CDATA[
        /*	getMovieSchListAjax  */
            SELECT
                MOVIE_ID
                , TITLE
            FROM
                MOVIE
        ]]>
        <where>
            <if test="schTitle != null and schTitle != ''">
                AND UPPER(REPLACE(TITLE, ' ', '')) LIKE CONCAT('%', UPPER(REPLACE(#{schTitle}, ' ', '')), '%')
            </if>
        </where>
        <![CDATA[
            ORDER BY POPULARITY DESC
            LIMIT 10
        ]]>
    </select>
</mapper>